name: Cloudflare DNS 检查

on:
  # 手动触发
  workflow_dispatch:
    inputs:
      max_age_hours:
        description: '记录超过多少小时算过期'
        required: false
        default: '4'
      check_interval:
        description: '检查间隔（小时）'
        required: false
        default: '4'
  # 定时触发 - 每小时检查一次，但会根据上次运行时间决定是否执行
  schedule:
    - cron: '0 * * * *'

jobs:
  check-dns:
    runs-on: ubuntu-latest

    steps:
      - name: 检查是否需要运行
        id: check-interval
        env:
          GH_TOKEN: ${{ github.token }}
          CHECK_INTERVAL: ${{ github.event.inputs.check_interval || '4' }}
        run: |
          # 手动触发时总是运行
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "手动触发，执行检查"
            echo "should_run=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # 获取上次成功运行的时间
          last_run=$(gh api repos/${{ github.repository }}/actions/workflows/check_dns.yml/runs \
            --jq '.workflow_runs | map(select(.conclusion == "success")) | .[0].updated_at // empty' 2>/dev/null || echo "")

          if [ -z "$last_run" ]; then
            echo "首次运行或无历史记录，执行检查"
            echo "should_run=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # 计算时间差
          last_ts=$(date -d "$last_run" +%s)
          now_ts=$(date +%s)
          diff_hours=$(( (now_ts - last_ts) / 3600 ))

          echo "上次运行: $last_run"
          echo "距离上次: ${diff_hours} 小时"
          echo "检查间隔: ${CHECK_INTERVAL} 小时"

          if [ "$diff_hours" -ge "$CHECK_INTERVAL" ]; then
            echo "已超过检查间隔，执行检查"
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "未到检查间隔，跳过本次"
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

      - name: 检查 DNS 记录
        if: steps.check-interval.outputs.should_run == 'true'
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ZONE_ID: ${{ secrets.CF_ZONE_ID }}
          CF_DOMAIN: ${{ secrets.CF_DOMAIN }}
          MAX_AGE_HOURS: ${{ github.event.inputs.max_age_hours || '4' }}
        run: |
          echo "============================================================"
          echo "Cloudflare DNS 记录检查"
          echo "============================================================"
          echo "域名: ${CF_DOMAIN}"
          echo "过期时间: ${MAX_AGE_HOURS} 小时"
          echo ""

          # 获取所有 DNS 记录
          response=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/dns_records?per_page=100" \
            -H "Authorization: Bearer ${CF_API_TOKEN}" \
            -H "Content-Type: application/json")

          success=$(echo "$response" | jq -r '.success')
          if [ "$success" != "true" ]; then
            echo "错误: API 调用失败"
            echo "$response" | jq '.errors'
            exit 1
          fi

          # 当前时间戳
          now=$(date +%s)
          max_age_seconds=$((MAX_AGE_HOURS * 3600))

          # 统计
          total=$(echo "$response" | jq '.result | length')
          echo "共找到 ${total} 条 DNS 记录"
          echo ""

          # 按类型统计
          echo "============================================================"
          echo "按类型统计"
          echo "============================================================"
          echo "$response" | jq -r '.result | group_by(.type) | .[] | "  \(.[0].type): \(length) 条"'
          echo ""

          # 按子域名分组并显示更新时间
          echo "============================================================"
          echo "DNS 记录详情"
          echo "============================================================"

          names=$(echo "$response" | jq -r '.result[].name' | sort -u)

          need_update=""
          up_to_date=""

          for name in $names; do
            count=$(echo "$response" | jq -r --arg name "$name" '[.result[] | select(.name == $name)] | length')

            # 获取最新修改时间
            modified=$(echo "$response" | jq -r --arg name "$name" \
              '[.result[] | select(.name == $name) | .modified_on] | sort | last // empty')

            # 获取记录类型
            record_type=$(echo "$response" | jq -r --arg name "$name" \
              '[.result[] | select(.name == $name) | .type] | unique | join(", ")')

            if [ -n "$modified" ]; then
              # 计算时间差
              modified_ts=$(date -d "$modified" +%s 2>/dev/null || echo "0")
              age_seconds=$((now - modified_ts))
              age_hours=$((age_seconds / 3600))
              age_minutes=$(((age_seconds % 3600) / 60))

              if [ $age_seconds -gt $max_age_seconds ]; then
                status="⚠️  需要更新"
                need_update="$need_update\n  - $name ($record_type)"
              else
                status="✓ 正常"
                up_to_date="$up_to_date\n  - $name ($record_type)"
              fi

              echo ""
              echo "【${name}】"
              echo "  类型: ${record_type}"
              echo "  记录数: ${count}"
              echo "  更新时间: ${age_hours}小时${age_minutes}分钟前"
              echo "  状态: ${status}"

              # 显示 IP 地址
              echo "  IP 地址:"
              echo "$response" | jq -r --arg name "$name" \
                '.result[] | select(.name == $name) | "    - \(.content)"'
            fi
          done

          echo ""
          echo "============================================================"
          echo "汇总"
          echo "============================================================"

          if [ -n "$need_update" ]; then
            echo "需要更新的记录:"
            echo -e "$need_update"
          else
            echo "需要更新的记录: 无"
          fi

          echo ""

          if [ -n "$up_to_date" ]; then
            echo "正常的记录:"
            echo -e "$up_to_date"
          fi

          echo ""
          echo "============================================================"
          echo "完成"
          echo "============================================================"
