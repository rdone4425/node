name: Ping Domains on Update

on:
  schedule:
    # 每10分钟检查一次文件是否更新
    - cron: '*/10 * * * *'
  workflow_dispatch:  # 允许手动触发

permissions:
  contents: write  # 允许推送代码
  actions: write   # 允许删除运行历史

jobs:
  check-and-ping:
    runs-on: windows-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: 下载域名列表
        run: |
          curl -s https://raw.githubusercontent.com/rdone4425/node/refs/heads/main/subdomains.txt -o domains_new.txt
          echo "下载的域名列表:"
          cat domains_new.txt

      - name: 检查文件是否更新
        id: check_update
        shell: powershell
        run: |
          if (Test-Path "domains_cache.txt") {
            if ((Compare-Object (Get-Content "domains_cache.txt") (Get-Content "domains_new.txt") -SyncWindow 0).Count -eq 0) {
              Write-Host "文件未更新，跳过 ping"
              "updated=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            } else {
              Write-Host "文件已更新，执行 ping"
              "updated=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            }
          } else {
            Write-Host "首次运行，执行 ping"
            "updated=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          }

      - name: Ping 域名并筛选可用域名
        if: steps.check_update.outputs.updated == 'true'
        shell: powershell
        run: |
          Write-Host "开始检测域名..."
          "域名,状态,响应时间" | Out-File -FilePath "ping_results.csv" -Encoding utf8
          "" | Out-File -FilePath "domains_available.txt" -Encoding utf8

          $total = 0
          $success = 0
          $failed = 0

          Get-Content "domains_new.txt" | ForEach-Object {
            $domain = $_.Trim()
            # 跳过空行和注释
            if ([string]::IsNullOrEmpty($domain) -or $domain.StartsWith("#")) {
              return
            }

            $total++
            Write-Host "正在检测 ($total): $domain"

            # 尝试多种方法检测域名
            $start_time = Get-Date

            # 方法1: 尝试 HTTPS
            try {
              $response = Invoke-WebRequest -Uri "https://$domain" -TimeoutSec 10 -UseBasicParsing -ErrorAction Stop
              $end_time = Get-Date
              $response_time = [math]::Round(($end_time - $start_time).TotalMilliseconds)
              "$domain,成功(HTTPS),${response_time}ms" | Out-File -FilePath "ping_results.csv" -Encoding utf8 -Append
              $domain | Out-File -FilePath "domains_available.txt" -Encoding utf8 -Append
              Write-Host "✓ $domain - 成功 HTTPS (${response_time}ms)"
              $success++
            }
            catch {
              # 方法2: 尝试 HTTP
              try {
                $response = Invoke-WebRequest -Uri "http://$domain" -TimeoutSec 10 -UseBasicParsing -ErrorAction Stop
                $end_time = Get-Date
                $response_time = [math]::Round(($end_time - $start_time).TotalMilliseconds)
                "$domain,成功(HTTP),${response_time}ms" | Out-File -FilePath "ping_results.csv" -Encoding utf8 -Append
                $domain | Out-File -FilePath "domains_available.txt" -Encoding utf8 -Append
                Write-Host "✓ $domain - 成功 HTTP (${response_time}ms)"
                $success++
              }
              catch {
                # 方法3: 尝试 ping（作为后备）
                $ping_result = Test-Connection -ComputerName $domain -Count 2 -TimeToLive 5 -ErrorAction SilentlyContinue
                if ($ping_result) {
                  $avg_time = [math]::Round($ping_result.ResponseTime.Average())
                  "$domain,成功(PING),${avg_time}ms" | Out-File -FilePath "ping_results.csv" -Encoding utf8 -Append
                  $domain | Out-File -FilePath "domains_available.txt" -Encoding utf8 -Append
                  Write-Host "✓ $domain - 成功 PING (${avg_time}ms)"
                  $success++
                } else {
                  "$domain,失败,N/A" | Out-File -FilePath "ping_results.csv" -Encoding utf8 -Append
                  Write-Host "✗ $domain - 失败"
                  $failed++
                }
              }
            }
          }

          Write-Host "总计: $total | 成功: $success | 失败: $failed"

      - name: 显示结果
        if: steps.check_update.outputs.updated == 'true'
        shell: powershell
        run: |
          Write-Host "========================================"
          Write-Host "Ping 结果汇总:"
          Write-Host "========================================"
          Get-Content "ping_results.csv"
          Write-Host ""
          $success_count = (Get-Content "ping_results.csv" | Where-Object { $_ -match "成功" }).Count
          $failed_count = (Get-Content "ping_results.csv" | Where-Object { $_ -match "失败" }).Count
          Write-Host "成功: $success_count 个"
          Write-Host "失败: $failed_count 个"

      - name: 更新 subdomains.txt
        if: steps.check_update.outputs.updated == 'true'
        shell: powershell
        run: |
          if ((Test-Path "domains_available.txt") -and ((Get-Content "domains_available.txt").Count -gt 0)) {
            Copy-Item "domains_available.txt" "subdomains.txt"
            Write-Host "已将可用域名写入 subdomains.txt"
            $domain_count = (Get-Content "subdomains.txt").Count
            Write-Host "可用域名数量: $domain_count"
          } else {
            Write-Host "没有可用域名，保持 subdomains.txt 不变"
          }

      - name: 提交 subdomains.txt
        if: steps.check_update.outputs.updated == 'true'
        shell: powershell
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add subdomains.txt
          $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
          git commit -m "更新可用域名列表 - $timestamp" 2>$null
          git push 2>$null

      - name: 删除运行历史
        if: always()
        shell: powershell
        run: |
          # 删除临时文件
          Remove-Item -Path "domains_new.txt" -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "domains_cache.txt" -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "domains_available.txt" -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "ping_results.csv" -Force -ErrorAction SilentlyContinue
          
          # 删除当前工作流运行历史
          try {
            $run_id = $env:GITHUB_RUN_ID
            $repo = $env:GITHUB_REPOSITORY
            $token = $env:GITHUB_TOKEN
            
            # 使用 GitHub API 删除运行历史
            $headers = @{
              "Authorization" = "token $token"
              "Accept" = "application/vnd.github.v3+json"
            }
            
            $api_url = "https://api.github.com/repos/$repo/actions/runs/$run_id"
            Invoke-RestMethod -Uri $api_url -Method Delete -Headers $headers
            Write-Host "已删除运行历史: $run_id"
          }
          catch {
            Write-Host "删除运行历史失败: $_"
          }
          
          Write-Host "清理完成"