name: Ping Domains on Update

on:
  schedule:
    # 每10分钟检查一次文件是否更新
    - cron: '*/10 * * * *'
  workflow_dispatch:  # 允许手动触发

permissions:
  contents: write  # 允许推送代码

jobs:
  check-and-ping:
    runs-on: windows-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: 下载域名列表
        run: |
          curl -s https://raw.githubusercontent.com/rdone4425/node/refs/heads/main/subdomains.txt -o domains_new.txt
          echo "下载的域名列表:"
          cat domains_new.txt

      - name: 检查文件是否更新
        id: check_update
        run: |
          if [ -f "domains_cache.txt" ]; then
            if diff -q domains_cache.txt domains_new.txt > /dev/null; then
              echo "文件未更新，跳过 ping"
              echo "updated=false" >> $GITHUB_OUTPUT
            else
              echo "文件已更新，执行 ping"
              echo "updated=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "首次运行，执行 ping"
            echo "updated=true" >> $GITHUB_OUTPUT
          fi

      - name: Ping 域名并筛选可用域名
        if: steps.check_update.outputs.updated == 'true'
        run: |
          echo "开始检测域名..."
          echo "域名,状态,响应时间" > ping_results.csv
          > domains_available.txt  # 清空可用域名文件

          total=0
          success=0
          failed=0

          while IFS= read -r domain; do
            # 跳过空行和注释
            if [[ -z "$domain" || "$domain" =~ ^# ]]; then
              continue
            fi

            total=$((total + 1))
            echo "正在检测 ($total): $domain"

            # 尝试多种方法检测域名
            start_time=$(date +%s%3N)

            # 方法1: 尝试 HTTPS
            if curl -s -m 10 --max-time 10 -o /dev/null -w "%{http_code}" "https://$domain" | grep -qE "^(200|301|302|304|403|404)"; then
              end_time=$(date +%s%3N)
              response_time=$((end_time - start_time))
              echo "$domain,成功(HTTPS),${response_time}ms" >> ping_results.csv
              echo "$domain" >> domains_available.txt
              echo "✓ $domain - 成功 HTTPS (${response_time}ms)"
              success=$((success + 1))
            # 方法2: 尝试 HTTP
            elif curl -s -m 10 --max-time 10 -o /dev/null -w "%{http_code}" "http://$domain" | grep -qE "^(200|301|302|304|403|404)"; then
              end_time=$(date +%s%3N)
              response_time=$((end_time - start_time))
              echo "$domain,成功(HTTP),${response_time}ms" >> ping_results.csv
              echo "$domain" >> domains_available.txt
              echo "✓ $domain - 成功 HTTP (${response_time}ms)"
              success=$((success + 1))
            # 方法3: 尝试 ping（作为后备）
            elif ping -c 2 -W 5 "$domain" > /dev/null 2>&1; then
              end_time=$(date +%s%3N)
              response_time=$((end_time - start_time))
              avg_time=$(ping -c 2 -W 5 "$domain" 2>&1 | tail -1 | awk -F '/' '{print $5}' || echo "N/A")
              echo "$domain,成功(PING),${avg_time}ms" >> ping_results.csv
              echo "$domain" >> domains_available.txt
              echo "✓ $domain - 成功 PING (${avg_time}ms)"
              success=$((success + 1))
            else
              echo "$domain,失败,N/A" >> ping_results.csv
              echo "✗ $domain - 失败"
              failed=$((failed + 1))
            fi
          done < domains_new.txt

          echo "总计: $total | 成功: $success | 失败: $failed"

      - name: 显示结果
        if: steps.check_update.outputs.updated == 'true'
        run: |
          echo "========================================"
          echo "Ping 结果汇总:"
          echo "========================================"
          cat ping_results.csv
          echo ""
          echo "成功: $(grep -c '成功' ping_results.csv || echo 0) 个"
          echo "失败: $(grep -c '失败' ping_results.csv || echo 0) 个"

      - name: 更新 subdomains.txt
        if: steps.check_update.outputs.updated == 'true'
        run: |
          if [ -f "domains_available.txt" ] && [ -s "domains_available.txt" ]; then
            cp domains_available.txt subdomains.txt
            echo "已将可用域名写入 subdomains.txt"
            echo "可用域名数量: $(wc -l < subdomains.txt)"
          else
            echo "没有可用域名，保持 subdomains.txt 不变"
          fi

      - name: 提交 subdomains.txt
        if: steps.check_update.outputs.updated == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add subdomains.txt
          git commit -m "更新可用域名列表 - $(date '+%Y-%m-%d %H:%M:%S')" || echo "无需提交"
          git push || echo "无需推送"